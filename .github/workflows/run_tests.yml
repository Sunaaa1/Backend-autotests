name: Run backend autotests

on:
 workflow_dispatch:

jobs:
 tests:
  runs-on: ubuntu-latest

  steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Set up Python
    uses: actions/setup-python@v5
    with:
      python-version: "3.13"

  - name: Install dependencies
    run: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
      pip install allure-pytest

  - name: Run tests and collect Allure results
    run: pytest --alluredir=allure-results

  - name: Install Allure CLI
    run: |
      curl -o allure-2.21.0.zip -L https://github.com/allure-framework/allure2/releases/download/2.21.0/allure-2.21.0.zip
      unzip allure-2.21.0.zip -d /opt/
      export PATH=$PATH:/opt/allure-2.21.0/bin
      allure --version

  - name: Generate Allure HTML report
    run: |
      export PATH=$PATH:/opt/allure-2.21.0/bin
      allure generate allure-results -o allure-report --clean

  - name: Upload Allure HTML report
    uses: actions/upload-artifact@v4
    with:
      name: allure-report
      path: allure-report
